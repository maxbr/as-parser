<html lang="en" ng-app="StarterApp">
<head>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.9.4/angular-material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=RobotoDraft:300,400,500,700,400italic">
    <meta charset="UTF-8"/>
    <meta name="description" content="Самый большой каталог страйкбольного снаряжения (пистолетов, автоматов, винтовок, приводов) со всех интернет магазинов с доставкой"/>
    <meta name="keywords" content="страйкбол,купить,привод,cyma,автомат,пистолет,страйкбольный,пневматический"/>
    <meta name="viewport" content="initial-scale=1"/>
    <link rel="icon" type="image/png" href="/img/icon.png" />
    <title>All-Airsoft.ru | Самый большой каталог страйкбольного снаряжения и приводов со всех магазинов страны с доставкой</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-animate.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.9.4/angular-material.min.js"></script>
    <style>
        .md-toolbar-tools h1 {
            font-size: inherit;
            font-weight: inherit;
            margin: inherit;
        }

        .gridListdemoBasicUsage md-grid-list {
            margin: 8px;
        }

        .gridListdemoBasicUsage .gray {
            background: #f5f5f5;
        }

        .gridListdemoBasicUsage md-grid-tile {
            transition: all 400ms ease-out 50ms;
        }

        a {
            text-decoration: none;
        }

        .autocompletedemoCustomTemplate .autocomplete-custom-template li {
            border-bottom: 1px solid #ccc;
            height: auto;
            padding-top: 8px;
            padding-bottom: 8px;
            white-space: normal; }

        .autocompletedemoCustomTemplate .autocomplete-custom-template li:last-child {
            border-bottom-width: 0;
        }

        .autocompletedemoCustomTemplate .autocomplete-custom-template .item-title,
        .autocompletedemoCustomTemplate .autocomplete-custom-template .item-metadata {
            display: block;
            line-height: 2;
        }

        .autocompletedemoCustomTemplate .autocomplete-custom-template .item-title md-icon {
            height: 18px;
            width: 18px;
        }
    </style>
    <script>
        var icons = [ // from http://www.flaticon.com/packs/solid-war-elements
            '/img/119358.svg', '/img/119325.svg', '/img/119344.svg', '/img/119363.svg', '/img/119352.svg'
        ];

        var app = angular.module('StarterApp', ['ngMaterial']);

        app.filter("prettyPrice", function(){
            return function(num){
                var str = num.toString().split('.');
                if (str[0].length >= 3) {
                    str[0] = str[0].replace(/(\d)(?=(\d{3})+$)/g, '$1 ');
                }
                if (str[1] && str[1].length >= 5) {
                    str[1] = str[1].replace(/(\d{3})/g, '$1 ');
                }
                return str.join('.');
            }
        });

        app.directive('checkImage', function($http) {
            return {
                restrict: 'A',
                link: function(scope, element, attrs) {
                    attrs.$observe('ngSrc', function(ngSrc) {
                        $http.get(ngSrc).success(function() {
                        }).error(function() {
                            element.attr('src', '/img/no-war.svg');
                        });
                    });
                }
            };
        });

        app.controller('AppCtrl', ['$scope', '$mdDialog', '$http', '$log', function ($scope, $mdDialog, $http, $log) {
            $scope.iconUrl = icons[Math.floor(Math.random() * icons.length)];
            $scope.sortOptions = [
                {id: 1, title: 'цена: по возрастанию'},
                {id: 2, title: 'цена: по убыванию'}
            ];

            $scope.loading = false;

            function myFunc(text) {
                $scope.loading = true;
                $http.get('/api/catalog?q=' + text)
                        .then(function(response) {
                            $scope.items = response.data;
                            $scope.loading = false;
                        });
            };

            $scope.imgError = function() {
                return '123';
            };

            $scope.imgLoaded = function() {
                return '123';
            };

            $scope.showAlert = function(ev) {
                alert('По различным вопросам пишите на почту: contact@all-airsoft.ru');
            };

            // sandbox
            $scope.simulateQuery = false;
            $scope.isDisabled = false;
            $scope.repos = loadAll();
            $scope.querySearch = querySearch;
            $scope.selectedItemChange = selectedItemChange;
            $scope.searchTextChange = searchTextChange;

            function querySearch (query) {
                var results = query ? $scope.repos.filter( createFilterFor(query) ) : $scope.repos,
                        deferred;
                if ($scope.simulateQuery) {
                    deferred = $q.defer();
                    $timeout(function () { deferred.resolve( results ); }, Math.random() * 1000, false);
                    return deferred.promise;
                } else {
                    return results;
                }
            }

            function searchTextChange(text) {
                myFunc(text);
                $log.info('Text changed to ' + text);
            }

            function selectedItemChange(item) {
                $log.info('Item changed to ' + JSON.stringify(item));
            }

            function loadAll() {
                var repos = [
//                    {
//                        'name': 'Cyma Glock 18c',
//                        'views': '12',
//                        'shop': 'рога и копыта'
//                    },
//                    {
//                        'name': 'LCT AK-47',
//                        'views': '47',
//                        'shop': 'ооо пупкин'
//                    }
                ];
                return repos.map(function (repo) {
                    repo.value = repo.name.toLowerCase();
                    return repo;
                });
            }

            function createFilterFor(query) {
                var lowercaseQuery = angular.lowercase(query);

                return function filterFn(item) {
                    return (item.value.indexOf(lowercaseQuery) === 0);
                };
            }
        }]);
    </script>
</head>

<body layout="column" ng-controller="AppCtrl">

<md-toolbar layout="row">
    <div class="md-toolbar-tools">
        <div layout="row" flex="25">
            <md-button class="md-icon-button" aria-label="Icon">
                <md-icon md-svg-icon="{{iconUrl}}"></md-icon>
            </md-button>

            <h1 style="padding-top:10px"><a href="/">All-Airsoft.ru</a></h1>
        </div>

        <form ng-submit="$event.preventDefault()" flex="45" style="margin-top:20px">
            <md-autocomplete
                    ng-disabled="isDisabled"
                    md-no-cache="noCache"
                    md-selected-item="selectedItem"
                    md-search-text-change="searchTextChange(searchText)"
                    md-search-text="searchText"
                    md-selected-item-change="selectedItemChange(item)"
                    md-items="item in querySearch(searchText)"
                    md-item-text="item.name"
                    md-min-length="0"
                    placeholder="Название"
                    md-menu-class="autocomplete-custom-template">
                <md-item-template>
                        <span class="item-title">
                            <md-icon md-svg-icon="http://image.flaticon.com/icons/svg/119/119336.svg"></md-icon>
                            <span> {{item.name}} </span>
                        </span>
                    <span class="item-metadata">
                            <span class="item-metastat">
                              <strong>{{item.views}}</strong> просмотров
                            </span>
                            <span class="item-metastat">
                              <strong>{{item.shop}}</strong> магазин
                            </span>
                        </span>
                </md-item-template>
            </md-autocomplete>
        </form>

        <span flex></span>

        <!-- pluso share buttons -->
        <!--<script type="text/javascript">(function() {-->
            <!--if (window.pluso)if (typeof window.pluso.start == "function") return;-->
            <!--if (window.ifpluso==undefined) { window.ifpluso = 1;-->
                <!--var d = document, s = d.createElement('script'), g = 'getElementsByTagName';-->
                <!--s.type = 'text/javascript'; s.charset='UTF-8'; s.async = true;-->
                <!--s.src = ('https:' == window.location.protocol ? 'https' : 'http')  + '://share.pluso.ru/pluso-like.js';-->
                <!--var h=d[g]('body')[0];-->
                <!--h.appendChild(s);-->
            <!--}})();</script>-->
        <!--<div class="pluso" style="margin-right:20px;" data-background="transparent" data-options="medium,square,line,horizontal,nocounter,theme=01" data-services="vkontakte,odnoklassniki,facebook,google" data-url="http://all-airsoft.ru" data-title="All-Airsoft.ru - Самый большой каталог страйкбольного снаряжения со всех интернет магазинов страны" data-description="описание страницы"></div>-->
        <!-- pluso share buttons -->

        <md-button class="md-primary md-raised" ng-click="showAlert($event)">Обратная связь</md-button>
    </div>
</md-toolbar>

<div layout="row" flex>
    <md-sidenav layout="column" class="md-sidenav-left md-whiteframe-z2" md-component-id="left"
                md-is-locked-open="$mdMedia('gt-sm')">
        filters
    </md-sidenav>

    <div layout="column" flex id="content">

        <md-content layout="column" flex class="md-padding">

            <div style="height:8px"><md-progress-linear ng-show="loading" md-mode="indeterminate"></md-progress-linear></div>

            <div layout-wrap layout-gt-sm="row" style="margin-left: 20px">
                <div flex-gt-sm="15">
                    <md-checkbox ng-model="inStoreCheckbox" aria-label="Checkbox 1" ng-model="inStoreCheckbox" ng-init="inStoreCheckbox = true">в наличии</md-checkbox>
                </div>

                <md-input-container flex-gt-sm="25" style="top:-15px">
                    <md-select ng-model="sortFilterOption">
                        <md-option ng-value="option.id" ng-repeat="option in sortOptions" ng-selected="$first">{{ option.title }}</md-option>
                    </md-select>
                </md-input-container>

                <div flex-gt-sm="45" style="position:relative;top:10px;padding-left:20px">
                    <div ng-show="items.length > 0">Найдено: <b>{{ items.length }}</b></div>
                    <div ng-show="!items.length">нет товаров, удовлетворяющих вашему запросу</div>
                </div>
            </div>

            <div class='md-padding' layout="row" style="padding-top:40px" layout-wrap>
                <md-card style="width: 200px;" ng-repeat="item in items | orderBy : 'price' : sortFilterOption == 2" ng-show="inStoreCheckbox == false || item.active == inStoreCheckbox">
                    <a href="/api/redirect?url={{ item.link }}" target="_blank">
                        <img check-image ng-src="/image_cache/{{ item.photo }}" class="md-card-image" alt="{{ item.title }}" style="width:50%;margin:20% 0 20% 25%;">
                    </a>
                    <md-card-content>
                        <div>
                            <a href="/api/redirect?url={{ item.link }}" target="_blank">{{ item.title }}</a>
                        </div>
                        <div class="md-body-1">{{ item.made }}</div>
                        <div class="md-headline">{{ item.price | prettyPrice }} руб.</div>
                        <span class="md-caption">Магазин: {{ item.store }}</span>
                        <!--<span class="md-caption">Просмотров: 12</span>-->
                    </md-card-content>
                    <!--<div class="md-actions" layout="row" layout-align="end center">-->
                        <!--<md-button>Save</md-button>-->
                        <!--<md-button>View</md-button>-->
                    <!--</div>-->
                </md-card>
            </div>
        </md-content>
    </div>
</div>

</body>
</html>
